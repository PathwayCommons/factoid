(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=function(a,b){return function(){return a.apply(b,arguments)}},u=Array.prototype.slice;window.sharejs=i={version:"0.4.1"},m=function(a){return setTimeout(a,0)},c=function(){function a(){}return a.prototype.on=function(a,b){var c;return this._events||(this._events={}),(c=this._events)[a]||(c[a]=[]),this._events[a].push(b),this},a.prototype.removeListener=function(a,b){var c,d,e;this._events||(this._events={}),d=(e=this._events)[a]||(e[a]=[]),c=0;while(c<d.length)d[c]===b&&(d[c]=void 0),c++;return m(t(function(){var b;return this._events[a]=function(){var c,d,e=this._events[a],f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b&&f.push(b);return f}.call(this)},this)),this},a.prototype.emit=function(){var a,b,c,d,e,f=arguments[0],g=2<=arguments.length?u.call(arguments,1):[];if((d=this._events)!=null?!d[f]:!void 0)return this;e=this._events[f];for(b=0,c=e.length;b<c;b++)a=e[b],a&&a.apply(this,g);return this},a}(),c.mixin=function(a){var b=a.prototype||a;return b.on=c.prototype.on,b.removeListener=c.prototype.removeListener,b.emit=c.prototype.emit,a};if(typeof module!="undefined"&&module!==null?module.exports:void 0)module.exports=c;i._bt=e=function(a,b,c,d){var e,f=function(a,c,d,e){return b(d,a,c,"left"),b(e,c,a,"right")};return a.transformX=a.transformX=e=function(a,b){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;c(a),c(b),k=[];for(p=0,t=b.length;p<t;p++){o=b[p],j=[],g=0;while(g<a.length){l=[],f(a[g],o,j,l),g++;if(l.length===1)o=l[0];else{if(l.length===0){x=a.slice(g);for(q=0,u=x.length;q<u;q++)h=x[q],d(j,h);o=null;break}y=e(a.slice(g),l),i=y[0],n=y[1];for(r=0,v=i.length;r<v;r++)h=i[r],d(j,h);for(s=0,w=n.length;s<w;s++)m=n[s],d(k,m);o=null;break}}o!=null&&d(k,o),a=j}return[a,k]},a.transform=a.transform=function(a,c,d){var f,g,h,i,j;if(d!=="left"&&d!=="right")throw new Error("type must be 'left' or 'right'");return c.length===0?a:a.length===1&&c.length===1?b([],a[0],c[0],d):d==="left"?(i=e(a,c),f=i[0],h=i[1],f):(j=e(c,a),h=j[0],g=j[1],g)}},p={},p.name="text",p.create=p.create=function(){return""},o=function(a,b,c){return a.slice(0,b)+c+a.slice(b)},f=function(a){var b,c;if(typeof a.p!="number")throw new Error("component missing position field");c=typeof a.i,b=typeof a.d;if(!(c==="string"^b==="string"))throw new Error("component needs an i or d field");if(!(a.p>=0))throw new Error("position cannot be negative")},g=function(a){var b,c,d;for(c=0,d=a.length;c<d;c++)b=a[c],f(b);return!0},p.apply=function(a,b){var c,d,e,f;g(b);for(e=0,f=b.length;e<f;e++){c=b[e];if(c.i!=null)a=o(a,c.p,c.i);else{d=a.slice(c.p,c.p+c.d.length);if(c.d!==d)throw new Error("Delete component '"+c.d+"' does not match deleted text '"+d+"'");a=a.slice(0,c.p)+a.slice(c.p+c.d.length)}}return a},p._append=d=function(a,b){var c,d,e;if(b.i===""||b.d==="")return;return a.length===0?a.push(b):(c=a[a.length-1],c.i!=null&&b.i!=null&&c.p<=(d=b.p)&&d<=c.p+c.i.length?a[a.length-1]={i:o(c.i,b.p-c.p,b.i),p:c.p}:c.d!=null&&b.d!=null&&b.p<=(e=c.p)&&e<=b.p+b.d.length?a[a.length-1]={d:o(b.d,c.p-b.p,c.d),p:b.p}:a.push(b))},p.compose=function(a,b){var c,e,f,h;g(a),g(b),e=a.slice();for(f=0,h=b.length;f<h;f++)c=b[f],d(e,c);return e},p.compress=function(a){return p.compose([],a)},p.normalize=function(a){var b,c,e,f,g=[];if(a.i!=null||a.p!=null)a=[a];for(c=0,e=a.length;c<e;c++)b=a[c],(f=b.p)==null&&(b.p=0),d(g,b);return g},r=function(a,b,c){return b.i!=null?b.p<a||b.p===a&&c?a+b.i.length:a:a<=b.p?a:a<=b.p+b.d.length?b.p:a-b.d.length},p.transformCursor=function(a,b,c){var d,e,f;for(e=0,f=b.length;e<f;e++)d=b[e],a=r(a,d,c);return a},p._tc=q=function(a,b,c,e){var f,h,i,j,k,l;g([b]),g([c]);if(b.i!=null)d(a,{i:b.i,p:r(b.p,c,e==="right")});else if(c.i!=null)l=b.d,b.p<c.p&&(d(a,{d:l.slice(0,c.p-b.p),p:b.p}),l=l.slice(c.p-b.p)),l!==""&&d(a,{d:l,p:b.p+c.i.length});else if(b.p>=c.p+c.d.length)d(a,{d:b.d,p:b.p-c.d.length});else if(b.p+b.d.length<=c.p)d(a,b);else{j={d:"",p:b.p},b.p<c.p&&(j.d=b.d.slice(0,c.p-b.p)),b.p+b.d.length>c.p+c.d.length&&(j.d+=b.d.slice(c.p+c.d.length-b.p)),i=Math.max(b.p,c.p),h=Math.min(b.p+b.d.length,c.p+c.d.length),f=b.d.slice(i-b.p,h-b.p),k=c.d.slice(i-c.p,h-c.p);if(f!==k)throw new Error("Delete ops delete different text in the same region of the document");j.d!==""&&(j.p=r(j.p,c),d(a,j))}return a},k=function(a){return a.i!=null?{d:a.i,p:a.p}:{i:a.d,p:a.p}},p.invert=function(a){var b,c,d,e=a.slice().reverse(),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(k(b));return f},i.types||(i.types={}),e(p,q,g,d),i.types.text=p,p.api={provides:{text:!0},getLength:function(){return this.snapshot.length},getText:function(){return this.snapshot},insert:function(a,b,c){var d;return b==null&&(b=0),d=[{p:b,i:a}],this.submitOp(d,c),d},del:function(a,b,c){var d=[{p:b,d:this.snapshot.slice(b,b+a)}];return this.submitOp(d,c),d},_register:function(){return this.on("remoteop",function(a){var b,c,d,e=[];for(c=0,d=a.length;c<d;c++)b=a[c],e.push(b.i!==void 0?this.emit("insert",b.i,b.p):this.emit("delete",b.d,b.p));return e})}},s||(s=i.types);if(!window.io)throw new Error("Must load socket.io before this library");l=window.io,b=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q;this.name=b,this.version=c,this.type=d;if(this.type.compose==null)throw new Error("Handling types without compose() defined is not currently implemented");m=t(function(a){return this.snapshot=a},this),m(e),g=null,f=[],k=null,j=[],l={},p=this.type.transformX||t(function(a,b){var c=this.type.transform(a,b,"left"),d=this.type.transform(b,a,"right");return[c,d]},this),i=t(function(a,b){var c=this.snapshot;return m(this.type.apply(this.snapshot,a)),b&&this.emit("remoteop",a,c),this.emit("change",a,c)},this),n=t(function(){if(g===null&&k!==null)return g=k,f=j,k=null,j=[],a.send({doc:this.name,op:g,v:this.version},t(function(a,b){var c,e,h,j,m,o,q,r=g;g=null;if(b){if(d.invert)e=this.type.invert(r),k&&(q=p(k,e),k=q[0],e=q[1]),i(e,!0);else throw new Error("Op apply failed ("+a.error+") and the OT type does not define an invert function.");for(h=0,m=f.length;h<m;h++)c=f[h],c(null,b)}else{if(a.v!==this.version)throw new Error("Invalid version from server");l[this.version]=r,this.version++;for(j=0,o=f.length;j<o;j++)c=f[j],c(r,null)}return n()},this))},this),this._onOpReceived=function(a){var b,c,d,e;if(a.v<this.version)return;if(a.doc!==this.name)throw new Error("Expected docName '"+this.name+"' but got "+a.doc);if(a.v!==this.version)throw new Error("Expected version "+this.version+" but got "+a.v);return c=a.op,l[this.version]=c,b=c,g!==null&&(d=p(g,b),g=d[0],b=d[1]),k!==null&&(e=p(k,b),k=e[0],b=e[1]),this.version++,i(b,!0)},this.submitOp=function(a,b){return this.type.normalize!=null&&(a=this.type.normalize(a)),m(this.type.apply(this.snapshot,a)),k!==null?k=this.type.compose(k,a):k=a,b&&j.push(b),this.emit("change",a),setTimeout(n,0)},this.flush=function(){return n()},this.close=function(b){return a.send({doc:this.name,open:!1},t(function(){b&&b(),this.emit("closed")},this))};if(this.type.api){q=this.type.api;for(h in q)o=q[h],this[h]=o;typeof this._register=="function"&&this._register()}else this.provides={};return this},c.mixin(b),a=function(){function a(a){this.onMessage=t(this.onMessage,this),this.connected=t(this.connected,this),this.disconnected=t(this.disconnected,this),this.docs={},this.numDocs=0,this.handlers={},this.socket=l.connect(a,{"force new connection":!0}),this.socket.on("connect",this.connected),this.socket.on("disconnect",this.disconnected),this.socket.on("message",this.onMessage),this.socket.on("connect_failed",t(function(a){var b,c,d,e,f,g,h;a==="unauthorized"&&(a="forbidden"),this.socket=null,this.emit("connect failed",a),g=this.handlers,h=[];for(d in g)e=g[d],h.push(function(){var d=[];for(f in e)c=e[f],d.push(function(){var d,e,f=[];for(d=0,e=c.length;d<e;d++)b=c[d],f.push(b(null,a));return f}());return d}());return h},this)),this.socket.socket.connected&&setTimeout(t(function(){return this.connected()},this),0)}return a.prototype.disconnected=function(){return this.emit("disconnect")},a.prototype.connected=function(){return this.emit("connect")},a.prototype.send=function(a,b){var c,d,e,f,g;if(this.socket===null)throw new Error("Cannot send messages to a closed connection");e=a.doc,e===this.lastSentDoc?delete a.doc:this.lastSentDoc=e,this.socket.json.send(a);if(b)return f=a.open===!0?"open":a.open===!1?"close":a.create?"create":a.snapshot===null?"snapshot":a.op?"op response":void 0,d=(g=this.handlers)[e]||(g[e]={}),c=d[f]||(d[f]=[]),c.push(b)},a.prototype.onMessage=function(a){var b,c,d,e,f,g,h,i=a.doc;i!==void 0?this.lastReceivedDoc=i:a.doc=i=this.lastReceivedDoc,this.emit("message",a),e=a.open===!0||a.open===!1&&a.error?"open":a.open===!1?"close":a.snapshot!==void 0?"snapshot":a.create?"create":a.op?"op":a.v!==void 0?"op response":void 0,c=(h=this.handlers[i])!=null?h[e]:void 0;if(c){delete this.handlers[i][e];for(f=0,g=c.length;f<g;f++)b=c[f],b(a,a.error)}if(e==="op"){d=this.docs[i];if(d)return d._onOpReceived(a)}},a.prototype.makeDoc=function(a){var c,d,e=a.doc;if(this.docs[e])throw new Error("Doc "+e+" already open");return d=a.type,typeof d=="string"&&(d=s[d]),c=new b(this,e,a.v,d,a.snapshot),c.created=!!a.create,this.docs[e]=c,this.numDocs++,c.on("closed",t(function(){return delete this.docs[e],this.numDocs--},this)),c},a.prototype.openExisting=function(a,b){if(this.socket===null){b(null,"connection closed");return}return this.docs[a]!=null?this.docs[a]:this.send({doc:a,open:!0,snapshot:null},t(function(a,c){return c?b(null,c):b(this.makeDoc(a))},this))},a.prototype.open=function(a,b,c){var d;if(this.socket===null){c(null,"connection closed");return}typeof b=="function"&&(c=b,b="text"),c||(c=function(){}),typeof b=="string"&&(b=s[b]);if(!b)throw new Error("OT code for document type missing");if(a!=null&&this.docs[a]!=null){d=this.docs[a],d.type===b?c(d):c(d,"Type mismatch");return}return this.send({doc:a,open:!0,create:!0,snapshot:null,type:b.name},t(function(a,d){return d?c(null,d):(a.snapshot===void 0&&(a.snapshot=b.create()),a.type=b,c(this.makeDoc(a)))},this))},a.prototype.create=function(a,b){return n(null,a,b)},a.prototype.disconnect=function(){if(this.socket)return this.emit("disconnected"),this.socket.disconnect(),this.socket=null},a}(),c.mixin(a),h={},j=function(b){var c,d;return d=window.location,b==null&&(b=""+d.protocol+"//"+d.hostname+"/sjs"),h[b]||(c=new a(b),c.on("disconnected",function(){return delete h[b]}),c.on("connect failed",function(){return delete h[b]}),h[b]=c),h[b]},n=function(a,b,c,d){var e;return typeof c=="function"&&(d=c,c=null),e=j(c),e.open(a,b,function(a,b){return a===null?(e.numDocs===0&&e.disconnect(),d(null,b)):(a.on("closed",function(){return setTimeout(function(){if(e.numDocs===0)return e.disconnect()},0)}),d(a))}),e.on("connect failed")},i.Connection=a,i.Doc=b,i.open=n}).call(this)